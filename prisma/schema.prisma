// SCHOOL-OS: The Source of Time & Truth
// Database Provider: PostgreSQL (Vercel Production Mode)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  // Vercel automatically injects this when you link a Postgres store
  url      = env("POSTGRES_PRISMA_URL") 
  // Used for migrations and direct connections
  directUrl = env("POSTGRES_URL_NON_POOLING")
}

// --- IDENTITY & ACCESS ---

enum UserRole {
  STUDENT
  TEACHER
  STAFF
  GUARDIAN
  ADMIN
  SYSTEM_DAEMON
}

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  taxId         String?   
  role          UserRole
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  studentProfile Student?
  teacherProfile Teacher?
  staffProfile   Staff?

  logs          AuditLog[]
  chatSessions  ChatSession[]
}

// --- THE HUMAN NODE ---

model Student {
  id                String   @id @default(uuid())
  userId            String   @unique
  user              User     @relation(fields: [userId], references: [id])
  
  academicGPA       Float    @default(0.0)
  financialBalance  Decimal  @default(0.00) @db.Decimal(10, 2)
  attendanceRate    Float    @default(100.0)
  npsScore          Int      @default(0)

  referralCode      String   @unique
  referredBy        String?
  referrer          Student? @relation("ReferralTree", fields: [referredBy], references: [id])
  referrals         Student[] @relation("ReferralTree")

  shardId           String?  @unique
  shard             AIShard? 

  varkProfile       CognitiveProfile?
  flowLogs          FlowLog[]
  enrollments       Enrollment[]
  
  @@index([referredBy])
}

// --- THE SYMBIOTIC ENGINE ---

model AIShard {
  id                String   @id @default(uuid())
  studentId         String   @unique
  student           Student  @relation(fields: [studentId], references: [id])
  
  version           String
  genesisDate       DateTime @default(now())
  lastResonanceSync DateTime
  
  cognitiveWeights  Json
  
  isVaulted         Boolean  @default(false)
  vaultKeyHash      String?
  
  resonanceHistory  ResonanceLog[]
}

model ResonanceLog {
  id        String   @id @default(uuid())
  shardId   String
  shard     AIShard  @relation(fields: [shardId], references: [id])
  score     Float
  delta     Float
  timestamp DateTime @default(now())
}

// --- THE LEDGER ---

enum TransactionType {
  INCOME
  EXPENSE
}

enum TaxRegime {
  ISS
  ICMS
}

model LedgerTransaction {
  id                String          @id @default(uuid())
  timestamp         DateTime        @default(now())
  description       String
  amount            Decimal         @db.Decimal(10, 2)
  type              TransactionType
  
  taxRegime         TaxRegime?
  taxBasis          Decimal?
  
  costCenterId      String?
  costCenter        CostCenter?     @relation(fields: [costCenterId], references: [id])
  
  commissionReceiverId String?
  commissionReceiver   Staff?       @relation(fields: [commissionReceiverId], references: [id])
  commissionAmount     Decimal?
}

model CostCenter {
  id           String              @id @default(uuid())
  name         String
  monthlyBudget Decimal
  transactions LedgerTransaction[]
}

// --- HUMAN CAPITAL ---

enum TeacherArchetype {
  ACADEMIC
  CREATIVE
  COACH
}

model Teacher {
  id              String   @id @default(uuid())
  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id])
  
  archetype       TeacherArchetype
  hourlyRate      Decimal
  
  prepLogs        PrepLog[]
  coursesTaught   Course[]
}

model Staff {
  id              String   @id @default(uuid())
  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id])
  role            String
  
  commissions     LedgerTransaction[]
}

// --- PEDAGOGY & ASSETS ---

model Course {
  id              String   @id @default(uuid())
  title           String
  basePrice       Decimal
  
  teacherId       String
  teacher         Teacher  @relation(fields: [teacherId], references: [id])
  
  enrollments     Enrollment[]
}

model Enrollment {
  id        String   @id @default(uuid())
  studentId String
  student   Student  @relation(fields: [studentId], references: [id])
  courseId  String
  course    Course   @relation(fields: [courseId], references: [id])
  status    String
}

model PrepLog {
  id          String   @id @default(uuid())
  teacherId   String
  teacher     Teacher  @relation(fields: [teacherId], references: [id])
  hours       Float
  cost        Decimal
  leverage    Float?
  createdAt   DateTime @default(now())
}

model FlowLog {
  id          String   @id @default(uuid())
  studentId   String
  student     Student  @relation(fields: [studentId], references: [id])
  score       Float
  timeTaken   Int
  state       String
  timestamp   DateTime @default(now())
}

model CognitiveProfile {
  id          String   @id @default(uuid())
  studentId   String   @unique
  student     Student  @relation(fields: [studentId], references: [id])
  
  visual      Float
  aural       Float
  readWrite   Float
  kinesthetic Float
  updatedAt   DateTime @updatedAt
}

// --- META-LAYER ---

model ChatSession {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  topic     String
  summary   String   @db.Text
  createdAt DateTime @default(now())
}

model AuditLog {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  action    String
  metadata  Json?
  timestamp DateTime @default(now())
}